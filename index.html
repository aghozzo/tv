// ... (rest of your code remains the same)

function play(url, clickedBtn) {
  // Remove active class...
  document.querySelectorAll('#buttons button').forEach(b => b.classList.remove('active'));
  clickedBtn?.classList.add('active');

  if (currentHls) {
    currentHls.destroy();
    currentHls = null;
  }

  if (Hls.isSupported()) {
  const config = {
    enableWorker: true,                    // Offload to worker (helps a lot on Pi)
    lowLatencyMode: true,                  // Still useful, but paired with small buffers
    liveSyncDurationCount: 3,              // Slightly more segments → better stability (was 2)
    liveMaxLatencyDurationCount: 8,        // Allow catching up without too aggressive seeking
    maxBufferLength: 10,                   // Target ~10s buffer (less memory/CPU strain)
    maxMaxBufferLength: 15,                // Hard cap to avoid RAM explosion
    maxBufferSize: 15 * 1000 * 1000,       // ~15MB cap – very important on Pi (default unlimited)
    backBufferLength: 20,                  // Trim old data faster
    abrEwmaFastLive: 5.0,                  // Slower bandwidth reaction → fewer quality flips (less CPU spikes)
    abrEwmaSlowLive: 12.0,
    abrBandWidthFactor: 0.75,              // More conservative down-switching
    abrBandWidthUpFactor: 0.6,
    enableSoftwareAES: true,               // Fallback if hardware crypto is slow
    testBandwidth: false,                  // Skip initial test fragment (saves resources on start)
    initialLiveManifestSize: 4             // Preload a few more entries for quicker recovery
  };

    currentHls = new Hls(config);
    currentHls.loadSource(url);
    currentHls.attachMedia(video);

    currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play().catch(e => console.log('Play error:', e));
    });

  currentHls.on(Hls.Events.FRAG_BUFFERED, function() {
    if (video.buffered.length > 0) {
      const bufferEnd = video.buffered.end(video.buffered.length - 1);
      const current = video.currentTime;
      const drift = bufferEnd - current;
      if (drift > 12) {          // Too much drift → very gentle catch-up
        video.playbackRate = 1.04; // Almost invisible speedup
      } else if (drift < 4) {
        video.playbackRate = 1.0;
      }
    }
  });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    // native Safari fallback – usually smoother on Apple hardware
    video.src = url;
    video.addEventListener('loadedmetadata', () => video.play().catch(() => {}), { once: true });
  }
}
