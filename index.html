// ... (rest of your code remains the same)

function play(url, clickedBtn) {
  // Remove active class...
  document.querySelectorAll('#buttons button').forEach(b => b.classList.remove('active'));
  clickedBtn?.classList.add('active');

  if (currentHls) {
    currentHls.destroy();
    currentHls = null;
  }

  if (Hls.isSupported()) {
    const config = {
      enableWorker: true,                  // offload to web worker if possible (good for Pi)
      lowLatencyMode: true,                // crucial for live TV – enables PART handling
      liveSyncDurationCount: 2,            // start ~2 segments behind live edge (default 3)
      liveMaxLatencyDurationCount: 5,      // if >5 segments behind → force catch-up
      maxBufferLength: 12,                 // target buffer ~12s (default 30s) – less waiting
      maxMaxBufferLength: 20,              // hard cap – prevents memory hogging on long play
      maxBufferSize: 0,                    // 0 = unlimited (or try 30*1000*1000 = 30MB)
      abrEwmaFastLive: 4.0,                // faster bandwidth reaction
      abrEwmaSlowLive: 10.0,
      abrBandWidthFactor: 0.90,            // more conservative down-switch → less starvation
      abrBandWidthUpFactor: 0.8,           // quicker up-switch when bandwidth good
      initialLiveManifestSize: 3,          // preload a bit more manifest entries at start
      backBufferLength: 30                 // keep some history (helps on seek/stall)
    };

    currentHls = new Hls(config);
    currentHls.loadSource(url);
    currentHls.attachMedia(video);

    currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play().catch(e => console.log('Play error:', e));
    });

    // Optional: gentle catch-up if drifting (some users like it)
    currentHls.on(Hls.Events.FRAG_BUFFERED, () => {
      if (video.buffered.length > 0) {
        const bufferEnd = video.buffered.end(video.buffered.length - 1);
        const current = video.currentTime;
        if (bufferEnd - current > 8) {  // too much buffer → gently speed up
          video.playbackRate = 1.08;    // 8% faster – almost unnoticeable
        } else {
          video.playbackRate = 1.0;
        }
      }
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    // native Safari fallback – usually smoother on Apple hardware
    video.src = url;
    video.addEventListener('loadedmetadata', () => video.play().catch(() => {}), { once: true });
  }
}
